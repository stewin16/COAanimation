<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU Instruction Simulator - MOVE R1, R2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
            margin: 0;
            padding: 8px;
        }

        @media (min-width: 768px) {
            body {
                padding: 16px;
            }
        }

        @media (min-width: 1024px) {
            body {
                padding: 24px;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .container {
                border-radius: 16px;
            }
        }

        .header {
            background: #1e293b;
            color: white;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        @media (min-width: 640px) {
            .header {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                padding: 16px 20px;
                gap: 12px;
            }
        }

        @media (min-width: 1024px) {
            .header {
                padding: 20px 32px;
            }
        }

        .header-left {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        @media (min-width: 640px) {
            .header-left {
                gap: 16px;
            }
        }

        @media (min-width: 1024px) {
            .header-left {
                gap: 24px;
            }
        }

        .scene-info {
            background: #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .scene-info {
                font-size: 13px;
                padding: 8px 14px;
            }
        }

        @media (min-width: 1024px) {
            .scene-info {
                font-size: 14px;
                padding: 8px 16px;
                border-radius: 8px;
            }
        }

        .student-info {
            background: #dc2626;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .student-info {
                font-size: 13px;
                padding: 8px 14px;
            }
        }

        @media (min-width: 1024px) {
            .student-info {
                font-size: 14px;
                padding: 8px 16px;
                border-radius: 8px;
                gap: 8px;
            }
        }

        .student-info::before {
            content: "👤";
            font-size: 10px;
        }

        @media (min-width: 1024px) {
            .student-info::before {
                font-size: 12px;
            }
        }

        .scroll-instruction {
            color: #94a3b8;
            font-size: 11px;
            font-style: italic;
            margin-top: 4px;
        }

        @media (min-width: 640px) {
            .scroll-instruction {
                font-size: 12px;
                margin-top: 0;
                text-align: right;
                flex: 1;
            }
        }

        @media (min-width: 1024px) {
            .scroll-instruction {
                font-size: 14px;
                color: #e2e8f0;
            }
        }

        .cpu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
            background: #f8fafc;
            position: relative; 
        }

        @media (min-width: 480px) {
            .cpu-grid {
                gap: 10px;
                padding: 14px;
            }
        }

        @media (min-width: 768px) {
            .cpu-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                padding: 16px;
            }
        }

        @media (min-width: 1024px) {
            .cpu-grid {
                display: grid;
                grid-template-columns: 1fr 2fr 1fr;
                grid-template-rows: repeat(4, minmax(0, 1fr));
                gap: 16px;
                min-height: 500px;
                height: auto;
                margin: 24px;
                padding: 20px;
                border-radius: 12px;
                border: 1px solid #e2e8f0;
            }
        }

        .data-transfer-box {
            position: absolute;
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-family: 'VT323', monospace;
            font-size: 22px;
            font-weight: bold;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: top 1.5s ease-in-out, left 1.5s ease-in-out, opacity 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }


        .component {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            min-height: 70px;
            padding: 8px;
            text-align: center;
            z-index: 1;
        }

        @media (min-width: 480px) {
            .component {
                min-height: 80px;
                padding: 10px;
                font-size: 14px;
                border-radius: 10px;
            }
        }

        @media (min-width: 768px) {
            .component {
                min-height: 90px;
                padding: 12px;
                font-size: 15px;
            }
        }

        @media (min-width: 1024px) {
            .component {
                font-size: 16px;
                border-radius: 12px;
                min-height: auto;
                padding: 16px;
            }
        }

        .component.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .pc {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: #1d4ed8;
            position: relative;
        }

        .pc-value {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            padding: 4px 7px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
            font-family: 'VT323', monospace;
        }

        @media (min-width: 480px) {
            .pc-value {
                top: -8px;
                right: -8px;
                padding: 5px 8px;
                font-size: 20px;
                border-radius: 10px;
            }
        }

        @media (min-width: 1024px) {
            .pc-value {
                padding: 5px 10px;
                font-size: 22px;
                border-radius: 12px;
            }
        }

        .control-unit {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-color: #6366f1;
            color: #4338ca;
            grid-column: span 2;
            min-height: 90px;
        }

        @media (min-width: 480px) {
            .control-unit {
                min-height: 100px;
            }
        }

        @media (min-width: 768px) {
            .control-unit {
                grid-column: span 1;
                min-height: 120px;
            }
        }

        @media (min-width: 1024px) {
            .control-unit {
                grid-row: span 2;
                font-size: 18px;
                min-height: auto;
            }
        }

        .registers {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            grid-column: span 2;
            min-height: 120px;
        }

        @media (min-width: 480px) {
            .registers {
                padding: 10px;
                min-height: 140px;
            }
        }

        @media (min-width: 768px) {
            .registers {
                grid-column: span 1;
                padding: 12px;
                min-height: 160px;
            }
        }

        @media (min-width: 1024px) {
            .registers {
                grid-row: span 2;
                padding: 16px;
                min-height: auto;
            }
        }

        .register-row {
            display: flex;
            justify-content: space-around;
            gap: 6px;
            margin: 2px 0;
        }

        @media (min-width: 480px) {
            .register-row {
                gap: 8px;
                margin: 3px 0;
            }
        }

        @media (min-width: 1024px) {
            .register-row {
                gap: 10px;
                margin: 4px 0;
            }
        }

        .register {
            flex: 1;
            background: white;
            border: 2px solid #d97706;
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-width: 40px;
        }

        @media (min-width: 480px) {
            .register {
                padding: 8px;
                min-width: 50px;
            }
        }

        @media (min-width: 768px) {
            .register {
                padding: 10px;
                border-radius: 7px;
            }
        }

        @media (min-width: 1024px) {
            .register {
                border-radius: 8px;
                padding: 12px;
            }
        }

        .register.highlighted {
            border-color: #dc2626;
            background: #fee2e2;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        }

        @media (min-width: 1024px) {
            .register.highlighted {
                transform: scale(1.05);
            }
        }

        .register-label {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 2px;
            color: #374151;
        }

        @media (min-width: 480px) {
            .register-label {
                font-size: 11px;
                margin-bottom: 3px;
            }
        }

        @media (min-width: 768px) {
            .register-label {
                font-size: 12px;
            }
        }

        @media (min-width: 1024px) {
            .register-label {
                font-size: 14px;
                margin-bottom: 4px;
            }
        }

        .register-value {
            font-size: 18px;
            font-weight: 700;
            color: white;
            background: #374151;
            padding: 3px 5px;
            border-radius: 4px;
            margin-top: 2px;
            font-family: 'VT323', monospace;
        }

        @media (min-width: 480px) {
            .register-value {
                font-size: 20px;
                padding: 4px 6px;
            }
        }

        @media (min-width: 768px) {
            .register-value {
                font-size: 22px;
                padding: 4px 7px;
                border-radius: 5px;
            }
        }

        @media (min-width: 1024px) {
            .register-value {
                font-size: 24px;
                padding: 6px 8px;
                border-radius: 6px;
                margin-top: 4px;
            }
        }

        .alu, .memory {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-color: #64748b;
            color: #475569;
        }

        .flags {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-color: #16a34a;
            color: #15803d;
            font-size: 11px;
            padding: 6px;
        }

        @media (min-width: 480px) {
            .flags {
                font-size: 12px;
                padding: 8px;
            }
        }

        @media (min-width: 768px) {
            .flags {
                font-size: 13px;
            }
        }

        @media (min-width: 1024px) {
            .flags {
                font-size: 14px;
                padding: 12px;
            }
        }

        .flag-item {
            margin: 2px 0;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 9px;
            font-weight: 600;
        }

        @media (min-width: 480px) {
            .flag-item {
                font-size: 10px;
                padding: 3px 5px;
            }
        }

        @media (min-width: 768px) {
            .flag-item {
                font-size: 11px;
                padding: 3px 6px;
            }
        }

        @media (min-width: 1024px) {
            .flag-item {
                margin: 4px 0;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
            }
        }

        .internal-bus {
            grid-column: span 2;
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            position: relative;
            overflow: hidden;
            border-color: #374151;
            min-height: 50px;
            order: 20;
        }

        @media (min-width: 480px) {
            .internal-bus {
                min-height: 60px;
            }
        }

        @media (min-width: 768px) {
            .internal-bus {
                grid-column: span 3;
                min-height: 70px;
            }
        }

        @media (min-width: 1024px) {
            .internal-bus {
                min-height: auto;
                order: 0;
            }
        }

        .instruction-panel {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 12px;
            margin: 8px;
        }

        @media (min-width: 480px) {
            .instruction-panel {
                padding: 14px;
                margin: 10px;
                border-radius: 8px;
            }
        }

        @media (min-width: 768px) {
            .instruction-panel {
                padding: 16px;
                margin: 12px;
                border-radius: 10px;
            }
        }

        @media (min-width: 1024px) {
            .instruction-panel {
                padding: 24px;
                margin: 0 24px 20px 24px;
                border-radius: 12px;
            }
        }

        .instruction-text {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
            color: #374151;
            min-height: 54px; /* Give space for text */
        }

        @media (min-width: 480px) {
            .instruction-text {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 12px;
                min-height: 60px;
            }
        }

        @media (min-width: 768px) {
            .instruction-text {
                font-size: 15px;
                line-height: 1.6;
                margin-bottom: 14px;
                min-height: 72px;
            }
        }

        @media (min-width: 1024px) {
            .instruction-text {
                font-size: 16px;
                margin-bottom: 16px;
                min-height: 75px;
            }
        }

        .current-instruction {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            color: white;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
        }

        @media (min-width: 480px) {
            .current-instruction {
                padding: 12px;
                font-size: 15px;
                border-radius: 7px;
            }
        }

        @media (min-width: 768px) {
            .current-instruction {
                padding: 14px;
                font-size: 16px;
            }
        }

        @media (min-width: 1024px) {
            .current-instruction {
                padding: 16px;
                font-size: 18px;
                border-radius: 8px;
            }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 12px;
            flex-wrap: wrap;
        }

        @media (min-width: 480px) {
            .step-indicator {
                gap: 10px;
                margin: 14px;
            }
        }

        @media (min-width: 768px) {
            .step-indicator {
                margin: 16px;
            }
        }

        @media (min-width: 1024px) {
            .step-indicator {
                gap: 8px;
                margin: 20px 24px;
            }
        }

        .step-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            font-size: 12px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 480px) {
            .step-dot {
                width: 34px;
                height: 34px;
                font-size: 13px;
            }
        }

        @media (min-width: 768px) {
            .step-dot {
                width: 36px;
                height: 36px;
            }
        }

        @media (min-width: 1024px) {
            .step-dot {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }

        .step-dot.active {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        .step-dot.completed {
            background: #059669;
            color: white;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 12px;
            align-items: stretch;
        }

        @media (min-width: 640px) {
            .controls {
                flex-direction: row;
                justify-content: center;
                gap: 12px;
                margin: 16px;
                align-items: center;
                flex-wrap: wrap;
            }
        }

        @media (min-width: 1024px) {
            .controls {
                margin: 20px 24px;
            }
        }

        .control-btn {
            padding: 14px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .control-btn:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (min-width: 480px) {
            .control-btn {
                padding: 14px 18px;
                font-size: 15px;
                min-height: 50px;
            }
        }

        @media (min-width: 640px) {
            .control-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-height: auto;
                flex: 1;
                max-width: 200px;
            }
        }

        @media (min-width: 1024px) {
            .control-btn {
                padding: 12px 24px;
                gap: 8px;
                flex: none;
            }
        }

        .start-btn { 
            background: linear-gradient(135deg, #059669, #047857); 
        }
        .start-btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #047857, #065f46); 
            transform: translateY(-1px);
        }
        .start-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .step-btn { 
            background: linear-gradient(135deg, #d97706, #b45309); 
        }
        .step-btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #b45309, #92400e); 
            transform: translateY(-1px);
        }
        .step-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .audio-btn { 
            background: linear-gradient(135deg, #7c3aed, #5b21b6); 
        }
        .audio-btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #5b21b6, #4c1d95); 
            transform: translateY(-1px);
        }
        .audio-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .reset-btn { 
            background: linear-gradient(135deg, #dc2626, #b91c1c); 
        }
        .reset-btn:hover:not(:disabled) { 
            background: linear-gradient(135deg, #b91c1c, #991b1b); 
            transform: translateY(-1px);
        }
        .reset-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .control-btn:hover:not(:disabled) {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @media (min-width: 1024px) {
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
        }
        .pulsing {
            animation: pulse 1s infinite;
        }

        /* Explicit Grid Areas for Desktop */
        @media (min-width: 1024px) {
            #pc { grid-area: 1 / 1 / 2 / 2; }
            #mar { grid-area: 2 / 1 / 3 / 2; }
            #memory { grid-area: 3 / 1 / 4 / 2; }
            #mdr { grid-area: 4 / 1 / 5 / 2; }
            #control-unit { grid-area: 1 / 2 / 3 / 3; }
            #internal-bus { grid-area: 3 / 2 / 4 / 3; }
            #ir { grid-area: 4 / 2 / 5 / 3; }
            #registers { grid-area: 1 / 3 / 3 / 4; }
            #alu { grid-area: 3 / 3 / 4 / 4; }
            #flags { grid-area: 4 / 3 / 5 / 4; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="scene-info">Scene 1 of 4</div>
                <div class="student-info">10745 Stewin Mathias</div>
            </div>
            <div class="scroll-instruction">
                Please scroll down for the controls
            </div>
        </div>

        <div class="cpu-grid" id="cpu-grid">
            <div class="data-transfer-box" id="data-transfer-box"></div>
            <!-- Column 1 -->
            <div class="component pc" id="pc">PC<div class="pc-value">300H</div></div>
            <div class="component" id="mar">MAR</div>
            <div class="component memory" id="memory">Memory</div>
            <div class="component" id="mdr">MDR</div>
            
            <!-- Column 2 -->
            <div class="component control-unit" id="control-unit">Control Unit</div>
            <div class="component internal-bus" id="internal-bus">
                Internal Bus
            </div>
            <div class="component" id="ir">IR</div>
            
            <!-- Column 3 -->
            <div class="component registers" id="registers">
                <div class="register-row">
                    <div class="register" id="r1"><div class="register-label">R1</div><div class="register-value" id="r1-value">00H</div></div>
                    <div class="register" id="r2"><div class="register-label">R2</div><div class="register-value" id="r2-value">42H</div></div>
                </div>
                <div class="register-row">
                    <div class="register" id="r3"><div class="register-label">R3</div><div class="register-value">00H</div></div>
                    <div class="register" id="r4"><div class="register-label">R4</div><div class="register-value">00H</div></div>
                </div>
            </div>
            <div class="component alu" id="alu">ALU</div>
            <div class="component flags" id="flags">
                <div>Flags</div>
                <div class="flag-item">Z=0</div>
                <div class="flag-item">C=0</div>
            </div>
        </div>

        <div class="instruction-panel">
            <div class="instruction-text" id="instruction-text">
                Our CPU is ready to execute: MOVE R1, R2. This instruction will copy the contents of register R2 (42H) into register R1.
            </div>
            <div class="current-instruction">
                MOVE R1, R2
            </div>
        </div>

        <div class="step-indicator">
            <div class="step-dot" id="step-1">1</div>
            <div class="step-dot" id="step-2">2</div>
            <div class="step-dot" id="step-3">3</div>
            <div class="step-dot" id="step-4">4</div>
        </div>

        <div class="controls">
            <button class="control-btn start-btn" onclick="startAnimation()">
                ▶ Start Execution
            </button>
            <button class="control-btn step-btn" onclick="stepAnimation()">
                ⏭ Step by Step
            </button>
            <button class="control-btn audio-btn" id="audio-btn" onclick="toggleAudio()">
                🔊 Audio ON
            </button>
            <button class="control-btn reset-btn" onclick="resetAnimation()">
                🔄 Reset
            </button>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let isAnimating = false;
        let stepMode = false;
        let isMuted = false;
        let stepInProgress = false;

        const steps = [
            {
                title: "Instruction Fetch: PC → MAR",
                description: "The Program Counter's address, 300H, is sent to the Memory Address Register to begin fetching the instruction.",
                components: ['pc', 'mar'],
                duration: 8000,
                transfer: true,
                data: '300H',
                from: 'pc',
                to: 'mar'
            },
            {
                title: "Memory Read: Memory → MDR",
                description: "The instruction at address 300H is retrieved from Memory and placed into the Memory Data Register.",
                components: ['memory', 'mdr'],
                duration: 8000,
                transfer: true,
                data: 'MOVE',
                from: 'memory',
                to: 'mdr'
            },
            {
                title: "Instruction Decode: MDR → IR",
                description: "The instruction moves to the Instruction Register, where the Control Unit decodes it as a MOVE operation.",
                components: ['mdr', 'ir', 'control-unit'],
                duration: 9000,
                transfer: true,
                data: 'MOVE',
                from: 'mdr',
                to: 'ir'
            },
            {
                title: "Execute: R2 → Bus → R1",
                description: "The content of register R2, which is 42H, travels via the internal bus and is copied into register R1.",
                components: ['r2', 'internal-bus', 'r1'],
                duration: 9000,
                transfer: true,
                data: '42H',
                path: ['r2', 'internal-bus', 'r1']
            }
        ];
        
        // --- Audio Functions ---
        function toggleAudio() {
            isMuted = !isMuted;
            const audioBtn = document.getElementById('audio-btn');
            audioBtn.innerHTML = isMuted ? '🔇 Audio OFF' : '🔊 Audio ON';
            if (isMuted) {
                speechSynthesis.cancel();
            }
        }

        function speak(text) {
            if (isMuted || !text) return;
            setTimeout(() => {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                speechSynthesis.speak(utterance);
            }, 100);
        }
        
        // --- Animation Logic ---

        function animateDirectTransfer(stepInfo, hideAtEnd = true) {
            const box = document.getElementById('data-transfer-box');
            const fromEl = document.getElementById(stepInfo.from);
            const toEl = document.getElementById(stepInfo.to);
            const grid = document.getElementById('cpu-grid');

            if (!box || !fromEl || !toEl || !grid) return;

            const gridRect = grid.getBoundingClientRect();
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();

            box.textContent = stepInfo.data;
            
            setTimeout(() => {
                const startX = fromRect.left - gridRect.left + (fromRect.width - box.offsetWidth) / 2;
                const startY = fromRect.top - gridRect.top + (fromRect.height - box.offsetHeight) / 2;
                box.style.transition = 'none';
                box.style.left = `${startX}px`;
                box.style.top = `${startY}px`;
                box.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                const endX = toRect.left - gridRect.left + (toRect.width - box.offsetWidth) / 2;
                const endY = toRect.top - gridRect.top + (toRect.height - box.offsetHeight) / 2;
                box.style.transition = 'top 1.5s ease-in-out, left 1.5s ease-in-out, opacity 0.5s ease-in-out';
                box.style.left = `${endX}px`;
                box.style.top = `${endY}px`;
            }, 200);

            if (hideAtEnd) {
                setTimeout(() => {
                    box.style.opacity = '0';
                }, 2000);
            }
        }

        function animateMultiStepTransfer(stepInfo) {
            animateDirectTransfer({ ...stepInfo, from: stepInfo.path[0], to: stepInfo.path[1] }, false);
            setTimeout(() => {
                animateDirectTransfer({ ...stepInfo, from: stepInfo.path[1], to: stepInfo.path[2] }, true);
            }, 2000);
        }

        function updateInstructionPanel(step) {
            const instructionText = document.getElementById('instruction-text');
            if (step >= 0 && step < steps.length) {
                const stepInfo = steps[step];
                instructionText.textContent = `Step ${step + 1}: ${stepInfo.title} - ${stepInfo.description}`;
                speak(stepInfo.description);
            }
        }

        function activateStep(stepNum) {
            document.querySelectorAll('.component').forEach(el => {
                el.classList.remove('active', 'pulsing', 'highlighted');
            });
            
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < stepNum) dot.classList.add('completed');
            });

            if (stepNum >= 0 && stepNum < steps.length) {
                document.getElementById(`step-${stepNum + 1}`).classList.add('active');
                
                const currentStepData = steps[stepNum];
                currentStepData.components.forEach(compId => {
                    const element = document.getElementById(compId);
                    if (element) {
                        element.classList.add('active', 'pulsing');
                    }
                });
                
                if (currentStepData.transfer) {
                    if (currentStepData.path) {
                        animateMultiStepTransfer(currentStepData);
                    } else {
                        animateDirectTransfer(currentStepData);
                    }
                }

                if (stepNum === 3) {
                    setTimeout(() => {
                        const r1ValueEl = document.getElementById('r1-value');
                        const r1El = document.getElementById('r1');
                        if (r1ValueEl && r1El) {
                            r1ValueEl.textContent = '42H';
                            r1El.classList.add('highlighted');
                        }
                    }, 4000); 
                }

                updateInstructionPanel(stepNum);
            }
        }

        function startAnimation() {
            if (isAnimating) return;
            isAnimating = true;
            stepMode = false;
            currentStep = 0;
            resetVisualElements();
            document.querySelector('.step-btn').disabled = true;
            
            function executeNextStep() {
                if (currentStep >= steps.length) {
                    isAnimating = false;
                    document.querySelector('.step-btn').disabled = false;
                    completeExecution();
                    return;
                }
                activateStep(currentStep);
                const stepDuration = steps[currentStep].duration;
                currentStep++;
                setTimeout(executeNextStep, stepDuration);
            }
            executeNextStep();
        }

        function stepAnimation() {
            if (stepInProgress || (isAnimating && !stepMode)) {
                return;
            }

            if (!stepMode) {
                stepMode = true;
                isAnimating = true; 
                currentStep = 0;
                resetVisualElements();
            }

            if (currentStep < steps.length) {
                stepInProgress = true;
                document.querySelector('.step-btn').disabled = true;
                document.querySelector('.start-btn').disabled = true;

                activateStep(currentStep);

                const currentStepDuration = steps[currentStep].duration;

                setTimeout(() => {
                    stepInProgress = false;
                    document.querySelector('.step-btn').disabled = false;
                    
                    if (currentStep >= steps.length - 1) {
                        isAnimating = false;
                        stepMode = false;
                        document.querySelector('.start-btn').disabled = false;
                        completeExecution();
                    } else {
                        currentStep++;
                    }
                }, currentStepDuration);
            }
        }


        function resetAnimation() {
            isAnimating = false;
            stepMode = false;
            stepInProgress = false;
            currentStep = 0;
            speechSynthesis.cancel();
            
            document.querySelector('.step-btn').disabled = false;
            document.querySelector('.start-btn').disabled = false;
            
            resetVisualElements();
            
            const initialText = "Our CPU is ready to execute: MOVE R1, R2. This instruction will copy the contents of register R2 (42H) into register R1.";
            document.getElementById('instruction-text').textContent = initialText;
            speak(initialText);
        }

        function resetVisualElements() {
            document.querySelectorAll('.component, .step-dot').forEach(el => {
                el.classList.remove('active', 'pulsing', 'show', 'completed', 'highlighted');
            });
            
            const box = document.getElementById('data-transfer-box');
            if(box) box.style.opacity = '0';

            document.getElementById('r1-value').textContent = '00H';
        }

        function completeExecution() {
            const finalText = "✅ Execution complete! Register R1 now contains 42H. The instruction cycle is finished.";
            document.getElementById('instruction-text').textContent = finalText;
            speak(finalText);
            document.querySelectorAll('.component').forEach(el => el.classList.remove('pulsing'));
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            switch(e.key.toLowerCase()) {
                case ' ': e.preventDefault(); if (!isAnimating) startAnimation(); break;
                case 's': if(!document.querySelector('.step-btn').disabled) stepAnimation(); break;
                case 'r': resetAnimation(); break;
                case 'm': toggleAudio(); break;
            }
        });

        // Initialize on load
        window.onload = resetAnimation;
    </script>
</body>
</html>

